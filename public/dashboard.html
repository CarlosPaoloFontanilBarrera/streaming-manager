<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIREH Streaming Manager - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #212529;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 400;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .controls {
            background: #f8f9fa;
            padding: 25px 30px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 280px;
            padding: 15px 20px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            background: white;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
            background: #fff;
        }
        
        .add-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc3545, #fd7e14);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: 900;
            color: #dc3545;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .stat-label {
            color: #495057;
            font-size: 0.95em;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .content {
            padding: 30px;
            background: white;
        }
        
        .accounts-list {
            display: grid;
            gap: 20px;
        }
        
        /* ESTILOS PARA ACORDEONES DESPLEGABLES */
        .account-accordion {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .account-accordion:hover {
            border-color: #dc3545;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .account-accordion.expanded {
            border-color: #dc3545;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.15);
        }
        
        .accordion-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px 30px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-bottom: 1px solid transparent;
        }
        
        .accordion-header:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }
        
        .accordion-header.active {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .accordion-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .accordion-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .accordion-title h3 {
            font-size: 1.4em;
            font-weight: 700;
            margin: 0;
        }
        
        .accordion-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .accordion-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .accordion-toggle {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: inherit;
        }
        
        .accordion-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        .accordion-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .accordion-content.expanded {
            padding: 30px;
            max-height: 2000px;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
        }
        
        .quick-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quick-btn-edit {
            background: #007bff;
            color: white;
        }
        
        .quick-btn-voucher {
            background: #17a2b8;
            color: white;
        }
        
        .quick-btn-comm {
            background: #28a745;
            color: white;
        }
        
        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .search-results-info {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-indicator.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-indicator.inactive {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-indicator.expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .profile-count {
            background: #6f42c1;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .days-remaining {
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .days-remaining.good {
            background: #d4edda;
            color: #155724;
        }
        
        .days-remaining.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* NOTIFICACIONES DE WHATSAPP */
        .whatsapp-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .whatsapp-notification.success {
            background: linear-gradient(45deg, #25d366, #20c997);
            color: white;
        }
        
        .whatsapp-notification.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        
        .whatsapp-notification.info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .system-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .system-status.active {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .system-status.inactive {
            background: rgba(220, 53, 69, 0.9);
        }
        
        /* Resto de estilos del proyecto original */
        /* ... mantengo todos los estilos existentes ... */
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: #dc3545;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .no-accounts {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }
        
        .no-accounts h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .no-accounts p {
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-indicator .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc3545;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .logout-btn {
                position: static;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            <h1>üé¨ JIREH Streaming Manager</h1>
            <p>Sistema con PostgreSQL en Railway - Alarmas Autom√°ticas</p>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" placeholder="üîç Buscar por nombre, email, tipo de servicio..." onkeyup="filterAccounts(this.value)">
            <button class="add-btn" onclick="openAddModal()">‚ûï Agregar Cuenta</button>
            <button class="btn" onclick="configureAlarms()" style="background: #ff6b35; color: white; padding: 15px 20px; border-radius: 10px; font-weight: 700;">üö® Configurar Alarmas</button>
            <button class="btn" onclick="testAlarmSystem()" style="background: #6f42c1; color: white; padding: 15px 20px; border-radius: 10px; font-weight: 700;">üß™ Test Alarmas</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAccounts">0</div>
                <div class="stat-label">Cuentas Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAccounts">0</div>
                <div class="stat-label">Cuentas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProfiles">0</div>
                <div class="stat-label">Perfiles Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiringAccounts">0</div>
                <div class="stat-label">Por Vencer</div>
            </div>
        </div>
        
        <div class="content">
            <div class="accounts-list" id="accountsList">
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Cargando cuentas desde Railway...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar cuenta -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Nueva Cuenta</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="accountForm">
                <div class="form-group">
                    <label for="clientName">Nombre del Cliente *</label>
                    <input type="text" id="clientName" required>
                </div>
                
                <div class="form-group">
                    <label for="clientPhone">Tel√©fono del Cliente</label>
                    <input type="tel" id="clientPhone">
                </div>
                
                <div class="form-group">
                    <label for="accountEmail">Email/Usuario *</label>
                    <input type="email" id="accountEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="accountPassword">Contrase√±a *</label>
                    <input type="password" id="accountPassword" required>
                </div>
                
                <div class="form-group">
                    <label for="accountType">Tipo de Servicio</label>
                    <select id="accountType">
                        <option value="Netflix Completa">Netflix Completa</option>
                        <option value="Disney+ Completa">Disney+ Completa</option>
                        <option value="Amazon Prime">Amazon Prime</option>
                        <option value="Max">Max</option>
                        <option value="Paramount+">Paramount+</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accountCountry">Pa√≠s</label>
                    <select id="accountCountry">
                        <option value="PE">üáµüá™ Per√∫</option>
                        <option value="US">üá∫üá∏ Estados Unidos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="providerStartDate">üìÖ Fecha Inicio (Compra del Proveedor) *</label>
                    <input type="date" id="providerStartDate" required>
                </div>
                
                <div class="form-group">
                    <label for="providerEndDate">üìÖ Fecha Fin (Vencimiento Proveedor) *</label>
                    <input type="date" id="providerEndDate" required>
                </div>
                
                <div class="form-group">
                    <label for="customDays">üìä D√≠as Restantes (Calculado Autom√°ticamente)</label>
                    <input type="number" id="customDays" readonly style="background: #f8f9fa; color: #495057; font-weight: bold;">
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar Cuenta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificaciones de WhatsApp -->
    <div id="whatsappNotification" class="whatsapp-notification"></div>
    
    <!-- Estado del sistema -->
    <div id="systemStatus" class="system-status active">
        üö® Sistema de Alarmas: <span id="systemStatusText">ACTIVO</span>
    </div>

    <script>
        // ===============================================
        // CONFIGURACI√ìN API PARA RAILWAY
        // ===============================================
        const API_BASE = '/api';
        
        // Variables globales
        let accounts = [];
        let editingAccountId = null;
        let allAccounts = [];
        let filteredAccounts = [];
        let searchTerm = '';
        
        // ===============================================
        // SISTEMA DE ALARMAS AUTOM√ÅTICAS MEJORADO
        // ===============================================
        
        // Configuraci√≥n de alarmas con tu n√∫mero
        const ALARM_CONFIG = {
            adminPhone: '51981804056', // TU N√öMERO FIJO
            providerAlarmDays: 3,
            clientAlarmDays: 2,
            checkInterval: 60000, // 1 minuto
            maxRetries: 3,
            autoSendEnabled: true
        };
        
        // Funci√≥n para enviar mensaje de WhatsApp AUTOM√ÅTICAMENTE
        function sendWhatsAppAlarm(phone, message) {
            console.log(`üì± Enviando mensaje autom√°tico a ${phone}`);
            
            try {
                // Limpiar y formatear el n√∫mero
                const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
                const formattedPhone = cleanPhone.startsWith('51') ? cleanPhone : `51${cleanPhone}`;
                
                // Codificar mensaje
                const encodedMessage = encodeURIComponent(message);
                
                // Crear m√∫ltiples URLs para m√°xima compatibilidad
                const urls = [
                    `https://wa.me/${formattedPhone}?text=${encodedMessage}`,
                    `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`,
                    `https://web.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`
                ];
                
                // Enviar usando m√∫ltiples m√©todos
                urls.forEach((url, index) => {
                    setTimeout(() => {
                        // Crear ventana invisible
                        const popup = window.open(url, `whatsapp_${index}`, 'width=1,height=1,top=0,left=0');
                        
                        // Intentar cerrar autom√°ticamente despu√©s de 3 segundos
                        setTimeout(() => {
                            try {
                                if (popup && !popup.closed) {
                                    popup.close();
                                }
                            } catch (e) {
                                console.log('No se pudo cerrar la ventana autom√°ticamente');
                            }
                        }, 3000);
                        
                    }, index * 1000); // Delay entre env√≠os
                });
                
                // Mostrar notificaci√≥n de √©xito
                showWhatsAppNotification('success', `‚úÖ Mensaje enviado a ${formattedPhone}`, message.substring(0, 50) + '...');
                
                console.log(`‚úÖ Mensaje enviado exitosamente a ${formattedPhone}`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error enviando mensaje:', error);
                showWhatsAppNotification('error', '‚ùå Error al enviar mensaje', error.message);
                return false;
            }
        }
        
        // Funci√≥n para mostrar notificaciones de WhatsApp
        function showWhatsAppNotification(type, title, message) {
            const notification = document.getElementById('whatsappNotification');
            notification.className = `whatsapp-notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 1.5em;">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                    </div>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">${message}</div>
                    </div>
                </div>
            `;
            
            notification.style.display = 'block';
            
            // Auto-hide despu√©s de 5 segundos
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Verificar alarmas del proveedor
        function checkProviderAlarms() {
            console.log('üîç Verificando alarmas del proveedor...');
            
            allAccounts.forEach(account => {
                const daysRemaining = account.daysRemaining;
                
                // Alarma 3 d√≠as antes
                if (daysRemaining === ALARM_CONFIG.providerAlarmDays) {
                    const message = `üö® *ALERTA PROVEEDOR - JIREH STREAMING*

‚ö†Ô∏è La cuenta del proveedor est√° por vencerse:

üìã *CUENTA:*
‚Ä¢ Proveedor: ${account.clientName}
‚Ä¢ Servicio: ${account.type}
‚Ä¢ Email: ${account.email}
‚Ä¢ D√≠as restantes: ${daysRemaining} d√≠as

üîÑ *ACCI√ìN REQUERIDA:*
‚Ä¢ Renovar cuenta con el proveedor URGENTE
‚Ä¢ Contactar proveedor para extensi√≥n
‚Ä¢ Evitar suspensi√≥n de servicio

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Alarma Autom√°tica*`;
                    
                    sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, message);
                }
                
                // Alarma 1 d√≠a antes
                if (daysRemaining === 1) {
                    const message = `üö® *CUENTA VENCE MA√ëANA - JIREH STREAMING*

‚ö†Ô∏è ATENCI√ìN: Tu cuenta del proveedor vence MA√ëANA

üìã *CUENTA:*
‚Ä¢ Proveedor: ${account.clientName}
‚Ä¢ Servicio: ${account.type}
‚Ä¢ Vencimiento: MA√ëANA

üîÑ *ACCI√ìN INMEDIATA:*
‚Ä¢ Renovar cuenta del proveedor HOY
‚Ä¢ Contactar proveedor urgente

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Alarma Cr√≠tica*`;
                    
                    sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, message);
                }
                
                // Alarma d√≠a del vencimiento
                if (daysRemaining === 0) {
                    const message = `üö® *CUENTA VENCE HOY - JIREH STREAMING*

‚ö†Ô∏è CR√çTICO: Tu cuenta del proveedor vence HOY

üìã *CUENTA:*
‚Ä¢ Proveedor: ${account.clientName}
‚Ä¢ Servicio: ${account.type}
‚Ä¢ Vencimiento: HOY

üîÑ *ACCI√ìN CR√çTICA:*
‚Ä¢ Renovar cuenta del proveedor AHORA
‚Ä¢ Contactar proveedor INMEDIATAMENTE

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Alarma Cr√≠tica*`;
                    
                    sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, message);
                }
            });
        }
        
        // Verificar alarmas de clientes
        function checkClientAlarms() {
            console.log('üîç Verificando alarmas de clientes...');
            
            const today = new Date();
            
            allAccounts.forEach(account => {
                account.profiles.forEach((profile, index) => {
                    if (profile.estado !== 'vendido' || !profile.fechaVencimiento) return;
                    
                    const vencimiento = new Date(profile.fechaVencimiento);
                    const diffDays = Math.ceil((vencimiento - today) / (1000 * 60 * 60 * 24));
                    
                    // Alarma 2 d√≠as antes
                    if (diffDays === ALARM_CONFIG.clientAlarmDays) {
                        const message = `üí∞ *ALERTA COBRO - JIREH STREAMING*

‚è∞ Cliente pr√≥ximo a vencer:

üë§ *CLIENTE:*
‚Ä¢ Nombre: ${profile.clienteNombre}
‚Ä¢ Tel√©fono: ${profile.clienteTelefono || 'No especificado'}
‚Ä¢ Perfil: ${profile.name} (PIN: ${profile.pin})

üì± *SERVICIO:*
‚Ä¢ Cuenta: ${account.type}
‚Ä¢ D√≠as restantes: ${diffDays} d√≠as

üîÑ *ACCI√ìN REQUERIDA:*
‚Ä¢ Contactar cliente para renovaci√≥n
‚Ä¢ Enviar comunicado de pago

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Alarma de Cliente*`;
                        
                        sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, message);
                    }
                    
                    // Alarma d√≠a del vencimiento
                    if (diffDays === 0) {
                        const message = `üö® *PERFIL VENCE HOY - JIREH STREAMING*

‚ö†Ô∏è PERFIL VENCE HOY:

üë§ *CLIENTE:*
‚Ä¢ Nombre: ${profile.clienteNombre}
‚Ä¢ Perfil: ${profile.name} (PIN: ${profile.pin})

üîÑ *ACCI√ìN INMEDIATA:*
‚Ä¢ Verificar si pag√≥ la renovaci√≥n
‚Ä¢ Contactar cliente urgente
‚Ä¢ Suspender perfil si no pag√≥

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Alarma Cr√≠tica*`;
                        
                        sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, message);
                    }
                });
            });
        }
        
        // Funci√≥n principal de verificaci√≥n
        function checkAllAlarms() {
            if (allAccounts.length === 0) {
                console.log('‚ÑπÔ∏è No hay cuentas para verificar alarmas');
                return;
            }
            
            try {
                checkProviderAlarms();
                checkClientAlarms();
                
                // Actualizar estado del sistema
                updateSystemStatus('active', `Verificando ${allAccounts.length} cuentas`);
                
                console.log(`‚úÖ Alarmas verificadas: ${new Date().toLocaleString('es-PE')}`);
                
            } catch (error) {
                console.error('‚ùå Error en sistema de alarmas:', error);
                updateSystemStatus('inactive', 'Error en sistema');
                
                // Enviar notificaci√≥n de error
                const errorMessage = `üö® *ERROR EN SISTEMA DE ALARMAS*

‚ùå Error: ${error.message}
‚è∞ ${new Date().toLocaleString('es-PE')}

*JIREH STREAMING - Error del Sistema*`;
                
                sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, errorMessage);
            }
        }
        
        // Actualizar estado del sistema
        function updateSystemStatus(status, message) {
            const statusElement = document.getElementById('systemStatus');
            const statusText = document.getElementById('systemStatusText');
            
            statusElement.className = `system-status ${status}`;
            statusText.textContent = message;
        }
        
        // Iniciar sistema de alarmas
        let alarmInterval;
        
        function startAlarmSystem() {
            console.log('üö® Iniciando sistema de alarmas autom√°ticas...');
            
            // Verificar inmediatamente
            checkAllAlarms();
            
            // Configurar verificaci√≥n peri√≥dica
            if (alarmInterval) {
                clearInterval(alarmInterval);
            }
            
            alarmInterval = setInterval(checkAllAlarms, ALARM_CONFIG.checkInterval);
            
            // Mensaje de inicio
            const startMessage = `üéâ *SISTEMA DE ALARMAS INICIADO*

‚úÖ Sistema funcionando correctamente

üì± *CONFIGURACI√ìN:*
‚Ä¢ WhatsApp: ${ALARM_CONFIG.adminPhone}
‚Ä¢ Verificaci√≥n: cada ${ALARM_CONFIG.checkInterval / 1000} segundos
‚Ä¢ Alarmas autom√°ticas: ACTIVAS

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Sistema Iniciado*`;
            
            setTimeout(() => {
                sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, startMessage);
            }, 3000);
            
            updateSystemStatus('active', 'SISTEMA INICIADO');
            console.log('‚úÖ Sistema de alarmas iniciado correctamente');
        }
        
        // Probar sistema de alarmas
        function testAlarmSystem() {
            const accountsCount = allAccounts.length;
            const activeAccounts = allAccounts.filter(acc => acc.daysRemaining > 5).length;
            const expiringAccounts = allAccounts.filter(acc => acc.daysRemaining <= 3).length;
            
            const testMessage = `üß™ *TEST - SISTEMA DE ALARMAS*

‚úÖ Sistema funcionando correctamente

üì± *CONFIGURACI√ìN:*
‚Ä¢ WhatsApp: ${ALARM_CONFIG.adminPhone}
‚Ä¢ Total cuentas: ${accountsCount}
‚Ä¢ Cuentas activas: ${activeAccounts}
‚Ä¢ Por vencer: ${expiringAccounts}

üí° *ESTE ES UN MENSAJE DE PRUEBA*
‚Ä¢ Si recibes este mensaje, el sistema funciona
‚Ä¢ Las alarmas se env√≠an autom√°ticamente
‚Ä¢ No necesitas hacer nada m√°s

‚è∞ ${new Date().toLocaleString('es-PE')}
*JIREH STREAMING - Test Exitoso*`;
            
            sendWhatsAppAlarm(ALARM_CONFIG.adminPhone, testMessage);
            
            alert(`üì± TEST ENVIADO

‚úÖ Mensaje de prueba enviado a ${ALARM_CONFIG.adminPhone}

El mensaje debe llegar autom√°ticamente a tu WhatsApp.
Si no llega, revisa tu conexi√≥n a internet.`);
        }
        
        // Configurar alarmas
        function configureAlarms() {
            const newPhone = prompt(`Tu n√∫mero de WhatsApp (actual: ${ALARM_CONFIG.adminPhone}):`, ALARM_CONFIG.adminPhone);
            
            if (newPhone && newPhone.trim()) {
                ALARM_CONFIG.adminPhone = newPhone.trim();
                
                alert(`‚úÖ Configuraci√≥n actualizada:

üì± WhatsApp: ${ALARM_CONFIG.adminPhone}
üîÑ Sistema reiniciado con nueva configuraci√≥n`);
                
                // Reiniciar sistema
                startAlarmSystem();
            }
        }
        
        // ===============================================
        // FUNCIONES B√ÅSICAS DEL SISTEMA
        // ===============================================
        
        // Funci√≥n para hacer peticiones API
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Cargar cuentas desde Railway
        async function loadAccounts() {
            try {
                const data = await apiRequest('/accounts');
                
                allAccounts = data.map(account => ({
                    ...account,
                    clientName: account.client_name,
                    clientPhone: account.client_phone,
                    daysRemaining: account.days_remaining,
                    profiles: typeof account.profiles === 'string' ? JSON.parse(account.profiles) : account.profiles,
                    fechaInicioProveedor: account.fecha_inicio_proveedor,
                    fechaVencimientoProveedor: account.fecha_vencimiento_proveedor
                }));
                
                accounts = [...allAccounts];
                filteredAccounts = [...allAccounts];
                
                console.log(`‚úÖ Cargadas ${allAccounts.length} cuentas desde Railway`);
                
            } catch (error) {
                console.error('‚ùå Error cargando cuentas:', error);
                allAccounts = [];
                accounts = [];
                filteredAccounts = [];
            }
        }
        
        // Actualizar estad√≠sticas
        async function updateStats() {
            try {
                const stats = await apiRequest('/stats');
                
                document.getElementById('totalAccounts').textContent = stats.total;
                document.getElementById('activeAccounts').textContent = stats.active;
                document.getElementById('totalProfiles').textContent = stats.profiles;
                document.getElementById('expiringAccounts').textContent = stats.expiring;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        // Renderizar cuentas (versi√≥n simplificada)
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            
            if (allAccounts.length === 0) {
                container.innerHTML = `
                    <div class="no-accounts">
                        <h3>üì± No hay cuentas registradas</h3>
                        <p>Haz clic en "Agregar Cuenta" para comenzar</p>
                    </div>
                `;
                return;
            }
            
            const html = filteredAccounts.map(account => {
                const statusClass = account.status === 'active' ? 'active' : account.status === 'inactive' ? 'inactive' : 'expired';
                const statusText = account.status === 'active' ? 'Activo' : account.status === 'inactive' ? 'Por Vencer' : 'Vencido';
                
                return `
                    <div class="account-accordion" style="padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${account.clientName}</h3>
                                <p>${account.type} - ${account.daysRemaining} d√≠as restantes</p>
                            </div>
                            <div>
                                <span class="status-indicator ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Filtrar cuentas
        function filterAccounts(searchValue) {
            searchTerm = searchValue.toLowerCase().trim();
            
            if (!searchTerm) {
                accounts = [...allAccounts];
                filteredAccounts = [...allAccounts];
            } else {
                accounts = allAccounts.filter(account => 
                    account.clientName.toLowerCase().includes(searchTerm) ||
                    account.type.toLowerCase().includes(searchTerm)
                );
                filteredAccounts = [...accounts];
            }
            
            renderAccounts();
        }
        
        // Funciones de modal
        function openAddModal() {
            document.getElementById('accountModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('accountModal').style.display = 'none';
        }
        
        // Logout
        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('streamingAdminLoggedIn');
                window.location.href = '/login';
            }
        }
        
        // Verificar autenticaci√≥n
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('streamingAdminLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // Inicializar aplicaci√≥n
        async function initApp() {
            console.log('üöÄ Iniciando JIREH Streaming Manager...');
            
            if (!checkAuth()) return;
            
            await loadAccounts();
            await updateStats();
            renderAccounts();
            
            // Iniciar sistema de alarmas autom√°ticas
            startAlarmSystem();
            
            console.log('‚úÖ Sistema cargado exitosamente');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // Cerrar modales con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('accountModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        });
        
        console.log('üéâ JIREH Streaming Manager con Alarmas Autom√°ticas - Listo');
    </script>
</body>
</html>
